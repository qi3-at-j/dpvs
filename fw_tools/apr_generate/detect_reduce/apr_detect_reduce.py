#!/usr/bin/env python

import sys
import os

support_ids=[6504,1614,3365,7037,346,3396,347,348,349,350,351,5265,353,354,355,12593,5266,12731,12981,5267,5268,5269,5270,7040,1615,1616,1617,1618,359,1619,2088,13440,13441,5282,5283,12512,3313,344,345,5284,361,13442,13443,1622,364,1623,1624,365,366,367,2089,5004,2090,1625,369,370,6505,7041,10150,10151,10152,3400,3401,376,377,10153,3402,378,10154,10155,10156,379,10157,10158,380,6506,381,3314,6508,392,9761,1629,1630,9762,3315,3316,9763,388,9764,3317,389,1631,9765,1632,1633,9766,391,3510,9767,384,9768,393,394,12515,12516,383,9770,387,1639,9772,1642,1643,9774,4871,385,3318,386,9779,420,1685,9836,5391,438,439,7042,10134,10135,10136,5392,10137,10138,5393,10139,5394,10140,10141,10142,1695,427,428,9848,3406,431,432,9854,478,9876,12594,1710,3297,458,9880,13000,3366,6548,459,9881,12596,6549,461,9882,13001,3340,460,3341,9884,3560,3561,6541,468,3298,3299,3300,467,9895,12603,3301,12620,3342,465,9911,484,6769,6770,6771,9912,9177,6772,6773,9913,12621,486,487,12622,9914,3319,3320,477,9916,3321,12623,482,9917,6545,1732,1733,1734,9920,5307,4977,6007,5308,1775,5303,13010,3364,3375,535,536,13021,1770,520,9960,6568,498,499,12685,1752,1753,9994,500,501,12686,496,497,542,541,6575,544,545,9996,562,1810,561,10180,564,1811,563,10181,626,10205,660,661,1846,10226,662,663,12739,10227,13438,10001,714,10002,715,6502,10003,716,10004,1848,717,10005,718,10006,5115,10007,13035,719,10008,1849,1850,1851,720,721,5116,10009,5117,10010,10011,10012,10013,10014,722,10015,723,724,10016,725,10017,1852,373,10018,726,728,1016,1853,5118,10019,10020,732,10021,1854,5618,1855,1017,1018,733,1857,5309,1858,1859,5310,5311,4656,5028,4657,4658,1860,1861,3325,3326,3327,10131,10132,700,966,967,968,969,970,971,699,979,978,976,977,10133,972,973,974,975,13036,930,932,933,914,915,916,1865,917,4970,4971,4972,4973,5126,1866,1867,924,925,3302,926,927,4974,929,928,4975,4976,5127,5207,918,919,920,921,922,1868,3303,5133,923,1869,3328,5447,5132,999,5103,10042,13037,3370,5088,5089,5090,10043,10035,5038,5091,10036,10037,5092,5093,5094,10038,5095,3329,10039,3330,10040,10041,5096,5097,1874,1875,1876,701,4659,10228,12893,12894,12895,13072,13073,13074,12631,12632,12633,12634,6127,6128,6129,7098,12750,1915,5966,1923,1925,1926,13371,1948,10096,10097,10098,1949,10099,10100,10101,10102,10103,10104,4788,2050,6291,6292,1882,1883,10325,4938,762,10337,761,10338,3409,1894,10339,6623,1895,10340,810,811,2011,2012,4963,2018,4964,10385,12751,12752,3331,5619,4855,4856,4857,814,4858,4859,4860,4861,815,816,10111,2167,2168,2169,10112,10113,771,10114,10115,10116,3739,10490,13110,13111,4862,4863,788,789,5617,791,4864,4865,4866,790,793,4867,4868,792,820,10751,5620,821,5621,5622,6607,2226,6608,6706,6609,6610,755,10823,837,838,2177,10105,10106,2178,10107,10108,10109,10110,748,10778,4032,4033,2322,4034,5935,2323,10909,4038,887,4039,4040,4041,4042,4043,4044,4045,4046,6739,4049,10911,5928,881,5913,5914,5915,5916,5894,892,5895,5896,893,5897,5898,5899,3411,2330,4941,2332,4982,5900,5901,5902,5903,5904,4854,2349,10850,6714,2350,2351,10851,4666,4667,2354,2355,10854,2433,901,2434,5905,4885,877,878,4886,5954,4887,5955,6036,874,3412,2449,4981,5929,5930,5931,5932,5933,5934,875,3333,3334,10869,12785,2457,4012,4013,4014,4015,4016,4017,7044,6790,4018,4019,4020,4021,6791,894,895,896,4022,4023,2305,897,898,6792,4024,4025,4668,6730,952,4669,6487,871,6488,6489,6490,6491,6492,2312,10900,2362,2363,5922,5923,5924,904,905,10955,4060,880,879,4061,7045,6793,6794,6795,10049,10050,10051,4062,4063,6764,943,6393,1012,2514,6394,962,963,2459,10984,2481,2482,11008,6814,2486,11014,2492,1006,1007,2498,2499,964,965,1011,1008,1009,1010,2511,2512,1004,1005,6041,1027,1028,1029,5150,1049,11051,4106,1031,1033,4107,1034,1035,4108,1036,4109,2521,1045,1046,11054,1044,11055,5160,1050,5151,11052,1056,11065,2532,2533,7046,10044,1061,10045,1062,5291,1063,1064,5178,10022,1065,10023,1066,1069,1059,11066,1057,1058,10066,10067,10068,10055,10056,10057,10159,10160,10069,10070,10071,10072,10073,10074,10075,10076,1075,10117,3383,1084,10118,5161,5162,10119,1085,5163,5164,5165,5166,10120,1086,10121,5167,5168,5169,5260,1089,5261,5262,5263,5264,1090,1091,5255,5256,5257,10087,1080,10088,10089,1081,10090,5238,5239,5240,10091,1082,10092,10093,10094,10095,10024,10025,1076,10026,10027,1077,10028,10029,2560,10030,10031,1078,10032,10033,1079,10034,10077,10078,5304,2584,2585,2586,10079,10080,2587,10081,2588,11120,5305,2589,2590,2591,2592,3446,1121,1122,10143,5329,1123,10144,1124,5330,5333,5334,1125,5335,5336,10145,1126,10146,1127,10147,10148,10149,1128,1129,5331,1130,5332,1131,1132,5152,1142,11126,5153,2604,6042,2605,5144,10127,10128,10129,3397,3398,1137,11143,1138,10130,1139,2618,1099,6104,6105,6106,2619,2620,11144,1155,1156,5010,2626,2658,2659,2660,2661,13247,13248,6861,2663,11174,1175,5414,5415,5416,1176,2664,2665,5417,5418,5419,1177,1178,3307,2630,3451,2631,1161,3420,1163,1164,9183,3421,5422,1168,1179,5244,5245,1180,13253,1181,1182,3431,5292,1183,9755,2649,2655,11169,6812,1169,11170,3452,3453,3454,11171,2657,4687,2684,4688,4689,2685,4690,4691,2686,2687,4692,4693,2688,4694,2697,2698,11179,4203,2701,4204,7047,4205,2702,4206,2703,4207,2704,4208,4209,2705,4210,2706,2707,2708,4211,2709,4212,1195,1197,1196,11181,1198,1200,1199,5285,5286,5287,5288,5289,5290,1194,2711,11182,2712,19551,19552,7048,5403,2713,5404,5407,2714,2715,2716,11183,2717,4853,5405,2718,5406,5408,2719,3387,1235,11291,13255,1234,3423,5378,5379,5380,5381,5382,5383,5384,4246,1230,4247,1231,11302,4248,6828,1232,4249,2828,1229,5374,9186,1228,6271,6272,6273,6274,6275,6974,1227,11365,6975,1226,11366,4955,1236,11371,6977,4311,4312,4313,2776,5856,5857,9187,4314,4315,4316,1240,1241,11377,6829,1239,11378,5361,1237,1238,5362,5363,5364,5365,5366,5367,4695,4696,2810,11277,1244,1242,11334,2909,1211,2910,11542,1246,11409,1223,11430,12473,1224,3435,2925,11432,6293,6294,6295,11443,9188,5249,1214,1215,5653,1213,5388,5389,5390,6985,2932,5371,5372,5373,5253,1263,6287,12628,12629,12630,1267,1268,9189,2945,9228,9229,2946,2947,2949,1296,5158,1297,1298,5043,5044,5045,5046,5971,2951,5972,5047,5048,5973,4799,5049,2952,4800,4801,4802,4803,4804,2953,5671,5672,5673,5674,5675,5676,5677,5678,5679,5680,5681,5682,3107,4805,3108,3109,4806,5050,4807,3110,4808,4809,3111,4810,5051,3305,3306,5052,4811,6999,3113,4812,6778,3114,5053,5054,5055,5056,2955,2956,2957,2958,2959,13430,13431,3119,6779,3437,3438,5847,5848,5849,5850,5851,5852,5853,5854,5855,1465,4699,5057,5058,5059,5157,5060,12647,3312,4700,5061,3129,4701,4702,5062,5063,5064,5065,5066,5067,5654,5655,5656,5657,4813,2961,4814,5658,3440,3441,5659,4815,2962,9190,9191,4816,5660,5661,5662,5663,664,2964,2965,2966,2967,2968,2969,1284,1285,1286,1294,1287,1288,1289,13316,11551,4817,2971,5875,5984,5876,5877,5985,5878,5879,13317,2972,3491,11552,1349,41,9385,559,89,196,15,13,14,27,11,6503,83,31,133,598,13322,13323,9173,9174,2976,7050,10052,10053,10054,11562,3004,1369,7039,6796,12838,12839,12877,12878,4709,3014,4710,11573,4711,1376,4712,3015,4713,6949,3016,4714,3424,3017,4715,1417,1404,6170,3025,3026,3027,3028,6171,6172,6173,3029,4721,1407,4722,6039,4723,1408,4724,4725,3425,3030,4726,4727,4728,4729,6146,6147,4735,1396,4736,3031,3032,4737,1397,4738,4739,3033,4740,3034,6148,6149,6150,6151,6049,6050,6051,6052,4741,1390,4742,3035,4743,3036,3037,4744,6053,6054,1395,6055,3116,11705,11706,4768,4769,4770,1448,3117,11609,11610,5711,1488,5712,5713,11611,5714,5715,5716,6359,3124,3125,6360,1470,3126,5664,5665,6894,6895,6896,9756,1492,4967,5683,5684,6599,12285,1457,6782,4997,11624,7051,3458,6784,3459,1435,11639,1436,5623,12502,3460,5624,5625,3065,3066,3067,4745,5626,3068,4746,4747,4748,5627,5628,5629,5630,5631,5632,5633,5634,6564,1483,1484,11668,11669,3082,4819,4820,4821,3083,4822,4823,4824,4825,4826,4827,4828,4829,4830,3084,4831,3085,3086,3087,4832,4833,4834,4835,4836,3088,5128,5129,5130,5131,5121,5122,1460,6786,3426,5123,11678,5124,5125,4837,4838,4839,1466,4840,4841,4842,4843,4844,4845,11680,11681,4846,3093,4847,4848,3094,4849,4850,4851,1468,4852,3095,5639,3099,3100,5640,5641,6602,6603,12875,12876,11688,12867,12868,4749,4750,4751,4752,4753,4754,4755,4756,4757,1462,4758,1463,9195,4759,4760,4761,3102,4762,4763,4764,4765,4766,4767,5864,5865,5866,5867,1471,5868,3311,5869,5870,5871,6217,3142,6218,6219,1582,1581,11763,9199,3145,11766,3146,3427,1510,11769,1533,1570,11776,3224,11724,7100,1547,11737,7101,1562,11739,3140,3141,11755,7087,1546,4969,1565,11828,6230,6231,1500,1501,1502,6232,6233,3190,1524,6306,6307,1572,13352,3228,3229,3230,3231,3232,3233,11930,3234,3235,3236,3237,5425,3238,5426,5427,11931,9211,3477,3239,1591,11936,1588,11929,1593,1592,11947,3255,3256,1600,1599,11952,1603,3262,3263,3264,3265,3266,3268,11958,3269,1604,3270,5428,3271,5429,3442,3428,3272,3273,3274,11959,3443,3275,3276,4777,4778,1605,4779,4780,4781,4782,4783,11960,4784,4785,4786,4787,11963,3279,3280,3281,3282,3444,3445,11964,1601,1602,3293,3294,11970,13388,13389,13060,13061,13062]


#
# rule header(12 bytes) format:
# id(4)  version(2)+engine(2)  len(2)+reserve(2)   len --> value len not include header
#
#     detect format:
#     type(2) + len(2) + value(len)
#     type(2) + len(2) + value(len)
#     ......
#

def get_value(ss):
    value = 0
    for n in ss:
        v = ord(n)
        value = value * 256 + v
    return value 

if __name__ == '__main__':
    if len(sys.argv) < 3:
        print('Input arg: detect_file_binary(IN) out_detect_file(OUT)')
        sys.exit(0)

    print('support_ids len {}'.format(len(support_ids)))

    f1 = open(sys.argv[1], 'rb')

    # get file total size
    f1.seek(0, 2)
    total_len = f1.tell()
    f1.seek(0, 0)
    print('{} len:{}'.format(sys.argv[1], total_len))

    process_len = 0
    rule_cnt = 0

    f2 = open(sys.argv[2], 'wb')

    while True:
        # get rule id
        id_str = f1.read(4)
        rule_id = get_value(id_str)

        # skip version(2)+engine(2)
        f1.seek(4, 1)

        # get detect len
        len_str = f1.read(2)
        rule_len = get_value(len_str)

        process_len += 12
        process_len += rule_len

        if process_len > total_len:
            print('invalid data.')
            break

        if rule_id in support_ids:
            # locate to header of rule 
            f1.seek(-10, 1)
            data = f1.read(12+rule_len)
            f2.write(data)
            support_ids.remove(rule_id)
        else:
            # skip reserve(2)+detect
            f1.seek(rule_len+2, 1)

        rule_cnt += 1
        if process_len == total_len:
            print('process end')
            break


    print('not found ids:{} list:{}'.format(len(support_ids), support_ids))
    print('total rule:{}'.format(rule_cnt))

    f1.close()
    f2.close()

